<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
  <meta name="generator" content="Jekyll v4.1.1">
  <title>Notebook</title>
  <script type="text/javascript" src="../js/xhr.js"></script>	

  <!-- link rel="canonical" href="https://getbootstrap.com/docs/4.5/examples/album/"-->

  <!-- Bootstrap core CSS -->
  <link href="../css/bootstrap.min.css" rel="stylesheet">

  <style>
    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }
  </style>
  <!-- Custom styles for this template -->
  <link href="../css/bk.css" rel="stylesheet">
  <link href="../css/bk_md.css" rel="stylesheet">
  <link href="../css/navbar-top-fixed.css" rel="stylesheet">
  <link href="../css/offcanvas.css" rel="stylesheet">
</head>

<body>

  <nav class="navbar navbar-expand-md navbar-dark bg-dark">
	<ul class="navbar-nav my-2 my-md-0">


		<!-- open -->
		<li class="nav-item dropdown">
			<!-- <button type="button" class="dropdown-toggle btn btn-outline-secondary "  href="#" id="navbarDarkDropdownMenuLink" role="button" data-toggle="dropdown"  aria-expanded="false">
				OPEN
			</button>&nbsp; -->
			<a class="dropdown-toggle nav-link"  href="#" id="navbarDarkDropdownMenuLink" data-toggle="dropdown"  aria-expanded="false">
				OPEN
			</a>

			<ul id="dpBookList" class="dropdown-menu dropdown-menu-dark" aria-labelledby="navbarDarkDropdownMenuLink">
				<li><a class="dropdown-item" href="#">Action</a></li>
				<li><a class="dropdown-item" href="#">Another action</a></li>
				<li><a class="dropdown-item" href="#">Something else here</a></li>
			</ul>
		</li>
	</ul>
    <a class="navbar-brand" href="#"  >		
		<div id="response"></div>
	</a>
	
    <text class="text-secondary text-decoration-none"></text>

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse"
      aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">

      <div class="navbar-nav mr-auto"></div>

      <ul class="navbar-nav my-2 my-md-0">
		
		<li class="nav-item">
			<a class="nav-link" href="./mng.html">Mng</a>
		</li>
		<li class="nav-item">
			<a class="nav-link" href="../">/Home <span class="sr-only">(current)</span></a>
		</li>

      </ul>

    </div>
  </nav>


  <main role="main">


    <div class="container">
		<div class="row">
			<div class="col">

				<div class="card-deck mb-3 ">

					<div id="divpageb" class="card mb-4 shadow-sm" onclick="eClickInpB()">
					<div class="card-header" onclick="eClickTitleB()">
						<h6 class="my-0 font-weight-normal pagetitle">

							<div class="row justify-content-around">
								<div id="titleb" class="col-8">
								tag
								</div>
								<div id="pageb" class="col-4" style="text-align: right;">
								--
								</div>
							</div>
						</h6>
					</div>
							<textarea class="card-body" id="tab" rows="5" onchange="eInpB(this.value)" onkeyup="eInpB(this.value)">loading...</textarea>
					</div>

					<div class="card mb-4 shadow-sm" onclick="eClickInpA()">
						<textarea class="card-body" style="height: 400px;"  id="taa" rows="5" onchange="eInpA(this.value)" onkeyup="eInpA(this.value)">loading...</textarea>

						<div id="damd" class="card-body" style="height: 400px; overflow:auto;" >
							<div id="content_md" class="markdown-body">@</div>
						</div>

					<div class="card-header" onclick="eClickTitleA()">
						<h6 class="my-0 font-weight-normal">

							<div class="row justify-content-around">
								<div class="col">
									<div class="d-flex" style="text-align: right; vertical-align:text-bottom;">

										<div class="d-inline">
											<button  onClick="bPrev()" type="button" class="btn btn-outline-secondary btn-sm">
											&lt;
											</button>
										</div>
										
										<div id="pagea" class="d-inline">
											--
										</div>
	
										<div class="d-inline">
											<button  onClick="bNext()" type="button" class="btn btn-outline-secondary btn-sm">
											&gt;
											</button>
										</div>
	
									</div>
								</div>
								<div class="col">
									<div id="titlea" class="col-8">
										-
									</div>
								</div>
								<div class="col">
									<div class="btn-group" role="group" >
										<button type="button" class="btn btn-outline-secondary btn-sm" id="butMd" onClick="bMd()">MD</button>
										<button type="button" class="btn btn-outline-secondary btn-sm" onClick="bMdHelp()">?</button>
									</div>
								</div>

							</div>
						</h6>
					</div>
					</div>
				
				</div>

			</div>
		</div><!-- row which contains card(pages) -->

		<div class="row"><!-- buttons -->
			<div class="col">
				<div class="d-flex">

					<button id="btnSave" class="btn btn-outline-secondary " type="button" onClick="bSave()">
						SAVE
					</button>
					&nbsp;
					<button onClick="bNew()" type="button" class="btn btn-outline-secondary ">
						NEW
					</button>
					&nbsp;

					<!--button id="btnADate" class="btn btn-outline-secondary btn-sm" type="button" onClick="bAdate()">+Date</button>
					&nbsp;&nbsp;&nbsp;
					-->

					<button id="butEdit" onClick="bEd()" type="button" class="btn btn-outline-secondary ">
						EDIT
					</button>
					<input id="input_title" type="text" class="form-control" placeholder="Tag..." onChange="eInpTitle()" >
				
					<button id="butMore" onClick="bMore()" type="button" class="btn btn-outline-secondary ">
						...
					</button>
				</div>
			</div>
		</div><!-- buttons -->

		<div id="morebuttons" class="row"><!-- more buttons -->
			<div class="col-md-6">
				<button class="btn btn-outline-secondary" type="button" onClick="bQTag()" >QTag</button>

				<button  onClick="bTest()" type="button" class="btn btn-outline-secondary ">
					TEST
				</button>

				<button onClick="bGetDraft()" type="button" class="btn btn-outline-secondary ">
					Get Draft
				</button>

				<button onClick="bTogglePageB()" type="button" class="btn btn-outline-secondary ">
					Backside
				</button>
			</div>
			<div class="col">
				<!-- move -->
				<div class="input-group mb-3">
					<div class="input-group-prepend" id="button-addon3">
						<button class="btn btn-outline-secondary" type="button" onClick="bMovePrev()" >&lt;M</button>
						<button class="btn btn-outline-secondary" type="button" onClick="bMoveNext()" >M&gt;</button>
						<button class="btn btn-outline-secondary" type="button" onClick="bMoveBfr()" >BFR</button>
					</div>
					<input id="input_movebfr" type="text" class="form-control" placeholder="" aria-label="Example text with two button addons" aria-describedby="button-addon3">
				</div>
			</div>
		</div><!-- more buttons -->
			
		
		<div class="row justify-content-between"><!-- 2nd msg board -->
			<div class="col-9">
				<div id="response2"></div>
			</div>
			<div class="col-3" style="text-align: right;">
				<div id="sessionstat" class="badge badge-secondary">...</div>
			</div>
		</div>

		<div class="row"><!-- page list -->
			<div class="col">
				<div id="pagelist" class="pagelist"></div>
			</div>
		</div>
    
    </div> <!-- container -->
  </main>
  


  <!-- Modal fAlert msg pop up-->
  <div class="modal fade" id="staticBackdrop" data-backdrop="static" data-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <!-- div class="modal-header">
        <h5 class="modal-title" id="staticBackdropLabel">Opps..</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div -->
        <div class="modal-body" id="modal_msg">
          Press one key at a time, [Shift] or [Ctrl]
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>


  <!-- bottom bar -->
  <!-- (now removed)-->

  <script src="../js/jquery-3.5.1.slim.min.js"></script>
  <script src="../js/bootstrap.bundle.min.js"></script>
  <script src="../js/marked/marked.min.js"></script>

  <script>
    /* gv */
    var gv_keyShift = false;
    var gv_keyCtrl = false;

    const C_CLASS_CARD_SEL = "card text-white bg-primary mb-4 shadow-sm";
    const C_CLASS_CARD_NOR = "card mb-4 shadow-sm"
    const C_CLASS_ITEM_SEL = "card col-12 text-white bg-primary";
    const C_CLASS_ITEM_NOR = "card col-12"
    const C_CLASS_BUTKEY_DOWN = "btn btn-primary ";
    const C_CLASS_BUTKEY_UP = "btn btn-outline-secondary ";
    const C_CLASS_BUTSAVE = "btn btn-primary btn-sm my-2 my-sm-0";
    const C_CLASS_BUTSAVED = "btn btn-outline-secondary btn-sm my-2 my-sm-0";
    
	const C_CLASS_BUTMEON = "btn btn-primary btn-sm";
    const C_CLASS_BUTMEOFF = "btn btn-secondary btn-sm my-2 my-sm-0";
    const C_CLASS_BUTMDON = "btn btn-outline-primary btn-sm";
    const C_CLASS_BUTMDOFF = "btn btn-outline-secondary btn-sm my-2 my-sm-0";
	
	const C_CLASS_LIGHT_S = "badge badge-success";
	const C_CLASS_LIGHT_W = "badge badge-warning";
	const C_CLASS_LIGHT_E = "badge badge-danger";
	
	const C_COLOR_TAG = "#007bff";

	const gv_timerInterval=2000;
	var gv_sesstok="";
	var gb_timeoutwarned=false;
    /* function */
    /** functions that operates the View        */

    function fSetEditOn() {
      gv_keyShift = true;
      document.getElementById("butEdit").setAttribute("class", C_CLASS_BUTKEY_DOWN);
    }
    function fSetEditOff() {
      gv_keyShift = false;
      document.getElementById("butEdit").setAttribute("class", C_CLASS_BUTKEY_UP);
    }

    function fSetMdEditOn() {
      document.getElementById("butMd").setAttribute("class", C_CLASS_BUTMEON);
    }
    function fSetMdEditOff() {
      document.getElementById("butMd").setAttribute("class", C_CLASS_BUTMEOFF);
    }
    function fSetMdDispOn() {
      document.getElementById("butMd").setAttribute("class", C_CLASS_BUTMDON);
    }
    function fSetMdDispOff() {
      document.getElementById("butMd").setAttribute("class", C_CLASS_BUTMDOFF);
    }

    function fSetSaveOn() {
      document.getElementById("btnSave").setAttribute("class", C_CLASS_BUTKEY_DOWN);
    }
    function fSetSaveOff() {
      document.getElementById("btnSave").setAttribute("class", C_CLASS_BUTKEY_UP);
    }


    function fAlert(iv_msg) {
      //document.getElementById("staticBackdropLabel").innerHTML=iv_title;
      document.getElementById("modal_msg").innerHTML = iv_msg;
      $('#staticBackdrop').modal();
    }

    /* update ui */
    /** --------------------------------------- */

    /*  click function */

    
/*---------------------------------------------*/
function lockPost(){
	gb_postlock=true;
	document.getElementById("navbarDarkDropdownMenuLink").disabled = true;
	document.getElementById("btnSave").disabled = true;
}
function unlockPost(){
	gb_postlock=false;
	document.getElementById("navbarDarkDropdownMenuLink").disabled = false;
	if(!gb_timeoutwarned) //do not unlock SAVE button if timeout
		document.getElementById("btnSave").disabled = false;
}
function checkPostLock(){ return gb_postlock;}
const POSTLOCK_IGNORE = 0;
const POSTLOCK_STRICT = 1;
const POSTLOCK_SILENT = 2;
/* POSTLOCK_
 STRICT: always check POSTLOCK, 
         will block action and show msg if POST is locking 
		 gb_postlock is locked while posted and waiting for response
 IGNORE: ignore POSTLOCK status,
         always send post
		 no change on gb_postlock
 SILENT: always check POSTLOCK,
	     will block action but NO msg if POST is locking 
		 no change on gb_postlock
*/
function post_no_response(iv_att_postlock,iv_pact,io,cbf,cbferr){

	if(iv_att_postlock==POSTLOCK_STRICT ||
	   iv_att_postlock==POSTLOCK_SILENT )
		if( checkPostLock() ){
			if(iv_att_postlock==POSTLOCK_STRICT)
				fAlert("Opps, please try again...");

			if(iv_att_postlock==POSTLOCK_SILENT){
				console.log("POSTLOCK_SILENT "+iv_pact)
				console.log(io);
			}
			return;
		}
	
	var oData=io;

	//push JSON str to a value of "js":
	var postData=encodeURIComponent(JSON.stringify(oData));
	//send data
	if(iv_att_postlock==POSTLOCK_STRICT) lockPost();
	xhrSend3(postData,function(oDataRt){
		if(iv_att_postlock==POSTLOCK_STRICT) unlockPost();
		// console.log(oDataRt);
		// printResponse(":"+oDataRt.msg);
		pap(oDataRt);
		cbf(oDataRt);
		// printResponse("called");
	},cbferr);
}
function post(iv_pact,io,cbf){
	printResponse("...");
	post_no_response(POSTLOCK_STRICT,iv_pact,io,cbf,function(error){
		unlockPost();
		printResponse(iv_pact+" server error");
		console.log("xhrSend3 error")
		console.log(error);
	});
}
function pap(oDataRt){
	//process after post

	//update session token
	if(oDataRt.session.token) gv_sesstok=oDataRt.session.token;

	//print msg
	if(oDataRt.msg != null) printResponse(":"+oDataRt.msg);

}
/*---------------------------------------------*/
var gv_timer0;
var gv_timer;
var gv_sel_page;
var gb_edit=false;	//true=editing
var gb_md=true;		//true=display in markdown format while display mode
var gb_me=false;	//true=display in markdown format while edit mode
var gb_changed=false;
var go_book;
var go_booklist;
// var gv_time_book_get;
var gb_postlock=false //true=locking and do not allow post

function updateTextarea(iv_id){
	if(gb_edit) document.getElementById(iv_id).disabled=false;
	else document.getElementById(iv_id).disabled=true;
}
/*---------------------------------------------*/
function fTest(){

}
    /******************************/

function getInitBook(){
	clearResponse();
	
	var oData={
		app:"bk",
		act:"getinit"
	};

	//push JSON str to a value of "js":
	// var postData=encodeURIComponent(JSON.stringify(oData));
	//send data
	// xhrSend2(postData,function(oDataRt){
	// 	printResponse(oDataRt.msg);

	// 	go_booklist=oDataRt.booklist;

	// 	go_book=oDataRt.book;

	// 	afterGetBookList();
	// 	afterGetBook();
	// },function(){
	// 	printResponse("get init server error");
	// });
	post("getInitBook",oData,function(oDataRt){
		printResponse(":"+oDataRt.msg);
		console.log("getInitBook:"+oDataRt.msg);
		go_booklist=oDataRt.booklist;
		go_book=oDataRt.book;
		afterGetBookList();
		afterGetBook();
	});
}


function getBook(iv_userid,iv_book){
	clearResponse();

	//prepare data to send:
	var lv_bookid = iv_book;
	var lv_dataid="bk_"+iv_book;
	var lv_unlockdataid=null;
	if(go_book!=null && gb_edit) lv_unlockdataid="bk_"+go_book.bookid;

	var oData={
		app:"bk",
		act:"get",
		bookid:lv_bookid,
		dataid:lv_dataid,
		session:{token:gv_sesstok},
		edit:gb_edit,
		unlockbook:lv_unlockdataid
	};

	//clear response div
	printResponse("");

	//push JSON str to a value of "js":
	// var postData=encodeURIComponent(JSON.stringify(oData));
	//send data
	// xhrSend2(postData,function(oDataRt){
	// 	printResponse(oDataRt.msg);
	// 	if(!oDataRt.pass) {
	// 		console.log("no access");
	// 		return;
	// 	}

	// 	go_book=oDataRt.book;
	// 	afterGetBook();
	// },function(){
	// 	printResponse("get book server error");
	// });
	post("getBook",oData,function(oDataRt){
		printResponse(":"+oDataRt.msg);
		if(!oDataRt.pass) {
			console.log("no access");
			return;
		}

		if(oDataRt.book!=null){
			go_book=oDataRt.book;
			afterGetBook();
		}
	});
}

function getDraft(){
	if(go_book==undefined || go_book==null)
		return;
	clearResponse();

	//prepare data to send:
	var oData={
		app:"bk",
		act:"getdraft",
		bookid:go_book.bookid,
		page:gv_sel_page,
		session:{token:gv_sesstok}
	};

	//push JSON str to a value of "js":
	// var postData=encodeURIComponent(JSON.stringify(oData));
	//send data
	// xhrSend2(postData,function(oDataRt){
	// 	printResponse(oDataRt.msg);
	// 	if(oDataRt.book)
	// 		afterGetDraft(oDataRt.book.sidea,oDataRt.book.sideb);
	// },function(){
	// 	printResponse("get draft server error");
	// });
	post("getDraft",oData,function(oDataRt){
		printResponse(":"+oDataRt.msg);
		if(oDataRt.book)
			afterGetDraft(oDataRt.book.sidea,oDataRt.book.sideb);
	});

}

    /******************************/

function afterGetBook(){

	// //reset time tag
	// gv_time_book_get=Date.now();

	if(go_book.openpage) gv_sel_page=go_book.openpage;
	else gv_sel_page=1;
	//show selected page content
	showPage(gv_sel_page);

	fSetSaveOff();
	gb_changed=false;
}

function afterGetDraft(iv_sidea,iv_sideb){
	
	document.getElementById('taa').value=iv_sidea;

	var lo=go_book.sheets[findPageIndex(gv_sel_page)];
	lo.sidea=iv_sidea;//todo base64 encode
	markPageChanged(lo);

	//only update side a for now
	
}

function afterGetBookList(){

	var lv_h="";
	var lv_t="</a></li>";
	var lv_a="";
	var lv_as="";

	var lo=go_booklist.list;

	for(var i=0;i<lo.length;i++){
		lv_h="<li><a class=\"dropdown-item\" href=\"#\" onClick=\"getBook('','"+lo[i].bookid+"') \" >";
		lv_a=lv_h+lo[i].title+lv_t;
		lv_as=lv_as+lv_a;
	}
	
	document.getElementById("dpBookList").innerHTML=lv_as;
	
}

function findPageIndex(iv_page){
	var rtv=-1;
	for(var i=0;i<go_book.sheets.length;i++){
		if(go_book.sheets[i].page==iv_page) {
			rtv=i;
			break;
		}
	}

	return rtv;
}
function lastPage(){
	var rtv=0;
	for(var i=0;i<go_book.sheets.length;i++)
		if(go_book.sheets[i].page>rtv) rtv=go_book.sheets[i].page;
	return rtv;
}

function shiftPage(co_sheet,iv_shift){
	co_sheet.page=co_sheet.page+iv_shift;
	markPageChanged(co_sheet);
}

function markPageChanged(io_sheet){
	if(io_sheet.dbflag!="N") io_sheet.dbflag="C";
	gb_changed=true;
}

function fResponse(oData){
	//document.getElementById("response").innerHTML=oData;
	console.log(oData);
}
    /******************************/
function genTagHtml(iv){
	if(!iv) return ''; //dont process empty iv
	return '<font color="'+C_COLOR_TAG+'" >['+iv+']</font>';
}

function genPageHtml(iv){
	return '<button type="button" class="btn btn-outline-dark btn-sm" style="border:0;" disabled>'+iv+'</button>';
}

function updateMdElements(){
	if( (!gb_edit && gb_md) || (gb_edit && gb_me) ){
		genSideAMd();
		document.getElementById("damd").style.display="";
		document.getElementById("taa").style.display="none";
	}else{
		document.getElementById("damd").style.display="none" ;
		document.getElementById("taa").style.display="" ;
	}

	if(gb_edit){
		if(gb_me) fSetMdEditOn();
		else fSetMdEditOff();
	}else{
		if(gb_md) fSetMdDispOn();
		else fSetMdDispOff();
	}
}
function genSideAMd(){
	//only need to display while in non-edit mode
	if(gb_edit) return;

	var lv=document.getElementById('taa').value;

    document.getElementById('content_md').innerHTML =
      marked.parse(lv);
}

function togglePageB(){
	var lv=document.getElementById("divpageb").style.display;
	//console.log(lv);
	if(lv=="") document.getElementById("divpageb").style.display="none" ;
	else document.getElementById("divpageb").style.display="";
}
function hidePageB(){
	document.getElementById("divpageb").style.display="none";
}

function toggleMoreButtons(){
	var lv=document.getElementById("morebuttons").style.display;
	//console.log(lv);
	if(lv=="") document.getElementById("morebuttons").style.display="none" ;
	else document.getElementById("morebuttons").style.display="";
}
function hideMoreButtons(){
	document.getElementById("morebuttons").style.display="none";
}

function showPage(iv_page){
	var lv_b="";
	var lv_a="";
	var lv_tb="";
	var lv_ta="";
	var lv_pb="";
	var lv_pa="";
	if(iv_page==1){
		lv_b="["+go_book.title+"]";  //show cover

		lv_a=go_book.sheets[findPageIndex(iv_page)].sidea;
		lv_ta=go_book.sheets[findPageIndex(iv_page)].title;
		lv_pa=go_book.sheets[findPageIndex(iv_page)].page;
	}else{
		lv_b=go_book.sheets[findPageIndex(iv_page-1)].sideb;
		lv_tb=go_book.sheets[findPageIndex(iv_page-1)].title;
		lv_pb=go_book.sheets[findPageIndex(iv_page-1)].page;
		if(iv_page==lastPage()+1)
			lv_a="(End of book)";
		else{
			lv_a=go_book.sheets[findPageIndex(iv_page)].sidea;
			lv_ta=go_book.sheets[findPageIndex(iv_page)].title;
			lv_pa=go_book.sheets[findPageIndex(iv_page)].page;
		}
	}
	
	document.getElementById('taa').value=lv_a;
	document.getElementById('tab').value=lv_b;
	document.getElementById('titlea').innerHTML=genTagHtml(lv_ta);
	document.getElementById('titleb').innerHTML=genTagHtml(lv_tb);
	document.getElementById('pagea').innerHTML=genPageHtml(lv_pa);
	document.getElementById('pageb').innerHTML=genPageHtml(lv_pb);
	document.getElementById('input_title').value=lv_ta;
	if(gb_md) genSideAMd();	//render markdown content if switch is on
	//when click from page list, need to set gv_sel_page:
	gv_sel_page=iv_page;
	printPageNum();//refresh page num to show sel mark []
}


function printPageNum(){
	var lv_title="";
	var lv="";
	var lv_seg="";
	var lv_segTag="";
	var lv_segCon="";
	//var lv_pageh='<button type="button" class="btn btn-outline-primary btn-sm" >';
	//var lv_paget='</button>';
	var lv_pageh='';
	var lv_paget='';
	var lv_change_mark='';
	var lv_changed=false;
	var p;

	//book title
	lv_title="["+go_book.title+"]";

	//page list
	for(var i=0;i<go_book.sheets.length;i++){
		p=i+1;
		var lo_sheet=go_book.sheets[findPageIndex(p)];
		// lv_segTag=go_book.sheets[findPageIndex(p)].title;
		lv_segTag=lo_sheet.title;
		lv_segTag=genTagHtml(lv_segTag);

		if(lo_sheet.dbflag=="N")      {lv_change_mark = "!"; lv_changed=true;}
		else if(lo_sheet.dbflag=="C") {lv_change_mark = "*"; lv_changed=true;}
		else lv_change_mark = ""
		
		// lv_segCon=getPreviewLine(go_book.sheets[findPageIndex(p)].sidea);
		lv_segCon=getPreviewLine(lo_sheet.sidea);
		if(p==gv_sel_page)	//curr page/side a
			lv_seg="==>&nbsp;<a href=# onClick='showPage("+p+")'>"+lv_pageh+p+lv_change_mark+lv_paget+"</a>&nbsp;";
		else if(p==gv_sel_page-1)	//prev page/side b
			lv_seg="-->&nbsp;<a href=# onClick='showPage("+p+")'>"+lv_pageh+p+lv_change_mark+lv_paget+"</a>&nbsp;";
		else	//non selected page
			lv_seg="...&nbsp;<a href=# onClick='showPage("+p+")'>"+lv_pageh+p+lv_change_mark+lv_paget+"</a>&nbsp;";
		lv=lv+lv_seg+lv_segTag+"&nbsp;"+lv_segCon+"<br>";
	}

	if(lv_changed) lv_title=lv_title+"*";

	//print:
	document.getElementById("pagelist").innerHTML=lv_title+"<br>"+lv;

}
function getPreviewLine(iv_str){
	var lv=iv_str;
	var lv_cutMax=20;//as const
	var lv_cutPos=10;

	//try to get \n
	lv_cutPos=lv.indexOf("\n");
	if(lv_cutPos<0) //then try to get \r
		lv_cutPos=lv.indexOf("\r");

	if(lv_cutPos<0) //then use default value lv_cutMax
		lv_cutPos=lv_cutMax;

	if(lv_cutPos>lv_cutMax) //too long, shorten to lv_cutMax
		lv_cutPos=lv_cutMax;

	return lv.substring(0,lv_cutPos);

}

function printResponse(iv){
	document.getElementById("response").innerHTML=iv;
	document.getElementById("response2").innerHTML=iv;
}
function clearResponse(){
	printResponse("");
}

function saveDraft(){
	if(go_book==undefined || go_book==null)
		return;

	var lv_a=document.getElementById('taa').value;
	var lv_b=document.getElementById('tab').value;

	if(lv_a.trim()=="" && lv_b.trim()=="")
		return; //empty content, draft not saving...

	//for now, only save side A
	printResponse("saving draft...");

	//prepare data to send:
	var oData={
		app:"bk",
		act:"savedraft",
		data:{
			bookid:go_book.bookid,
			page:gv_sel_page,
			// sidea:document.getElementById('taa').value,//todo base64 encode
			// sideb:document.getElementById('tab').value//todo base64 encode
			sidea:lv_a,//todo base64 encode
			sideb:lv_b//todo base64 encode
		},
		session:{token:gv_sesstok}
	};

	//push JSON str to a value of "js":
	// var postData=encodeURIComponent(JSON.stringify(oData));
	//send data
	// xhrSend2(postData,function(oDataRt){
	// 	printResponse(oDataRt.msg);
	// },function(){
	// 	printResponse("draft saving server error");
	// });
	post("saveDraft",oData,function(oDataRt){
		printResponse(":"+oDataRt.msg);
	});

}
    /******************************/
function bEd(){
	//block action if content has changed
	if(gb_edit && gb_changed){
		var lv_but='<button class="btn btn-primary btn-sm" type="button" onClick="bEdctn()" data-dismiss="modal">CONTINUE WITHOUT SAVE</button>';
		var lv_msg=' \
Content changed, please:<br>\
Click SAVE to save, or<br>\
Click '+lv_but+' to cancel your change and back to display mode';
		fAlert(lv_msg);
		return;
	}
	fEdit();
}
function fEdit(){
	var lv_act;
	var lv_dataid="bk_"+go_book.bookid;

	if(gb_edit) lv_act='disp';
	else lv_act = 'edit';

	post("bEd",{
		app:"bk",
		act:lv_act,
		bookid:go_book.bookid,
		dataid:lv_dataid,
		session:{token:gv_sesstok}
	},function(oDataRt){
		console.log(oDataRt);
		gb_edit=oDataRt.dlock.edit;
		
		if(gb_edit){
			fSetEditOn();
		}else{
			fSetEditOff();
		}
		updateTextarea("tab");
		updateTextarea("taa");
		updateMdElements();

		if(oDataRt.book!=null) {
			go_book=oDataRt.book;
			fSetSaveOff();
			gb_changed=false;
		}
		showPage(gv_sel_page); //re-render markdown content
	});


}
function bEdctn(){
	if(gb_edit) fEdit();
	else alert("bEdctn error"); //should never happen
}

function bGetDraft(){
	getDraft();
}

function bTogglePageB(){
	togglePageB();
}

function bNew(){
	clearResponse();
	
	var lv_newP=gv_sel_page;//+1;
	//new empty page:
	var lo_p={
		//sheetid:2, id is gen by db
		page:lv_newP,
		bookid:go_book.bookid,
		title:"",
		sidea:"",
		sideb:"",
		dbflag:"N"
	};

	//update page number after
	var lv_lastPage=go_book.sheets[findPageIndex(go_book.sheets.length)];
	for(var i=0;i<go_book.sheets.length;i++)
		if(go_book.sheets[i].page>=lv_newP)
			shiftPage(go_book.sheets[i],1);

	//insert into go_book
	go_book.sheets.push(lo_p);


	//below similar as bGetSheetsList:
	//gen&print sheet pages
	printPageNum();

	//sow selected page content
	showPage(gv_sel_page);

	//reminder user:
	printResponse("click SAVE before typing!!!");
	fSetSaveOn();

}

// function bAdate(){
// 	clearResponse();

// 	if(!gb_edit){
// 		printResponse("not in edit mode");
// 		return;
// 	}

// 	//var l=document.selection.createRane();
// 	//var range = input.createTextRange();        //创建一个文本选区对象
// 	//range.select();   //将选区对象包含的内容选中。

// 	console.log(document.activeElement.id);

// }

function bMd(){
	if(gb_edit){
		if(gb_me){
			gb_me=false;
		}else{
			gb_me=true;
		}
	}else{
		if(gb_md){
			gb_md=false;
		}else{
			gb_md=true;
		}
	}
	updateMdElements();
}
function bMdHelp(){
	var lv = "Use [MD] button to switch Markdown style:<br>\
<button type=\"button\" class=\""+C_CLASS_BUTMDOFF+"\">MD</button> -- Source text, not editing<br>\
<button type=\"button\" class=\""+C_CLASS_BUTMDON+"\">MD</button> --  Markdown style, not editing<br>\
<br>\
<button type=\"button\" class=\""+C_CLASS_BUTMEOFF+"\">MD</button> -- Source text, editing<br>\
<button type=\"button\" class=\""+C_CLASS_BUTMEON+"\">MD</button> -- Markdown style, editing (you cannot edit but get a preview)<br>\
<br>\
Check <a href=\"./md.html\" target=\"_blank\">this page</a> to play around the Markdown text<br>\
<br>\
Check below for supported Markdown syntax:<br>\
<br>\
### Heading<br>\
<br>\
# H1<br>\
## H2<br>\
### H3<br>\
<br>\
### Bold<br>\
<br>\
**bold text**<br>\
<br>\
### Italic<br>\
<br>\
*italicized text*<br>\
<br>\
### Blockquote<br>\
<br>\
> blockquote<br>\
<br>\
### Ordered List<br>\
<br>\
1. First item<br>\
2. Second item<br>\
3. Third item<br>\
<br>\
### Unordered List<br>\
<br>\
- First item<br>\
- Second item<br>\
- Third item<br>\
<br>\
### Code<br>\
<br>\
`code`<br>\
<br>\
### Horizontal Rule<br>\
<br>\
---<br>\
<br>\
### Link<br>\
<br>\
[Markdown Guide](https://www.markdownguide.org)<br>\
<br>\
### Image<br>\
<br>\
![alt text](https://www.markdownguide.org/assets/images/tux.png)<br>\
<br>\
### Table<br>\
<br>\
| Syntax | Description |<br>\
| ----------- | ----------- |<br>\
| Header | Title |<br>\
| Paragraph | Text |<br>\
<br>\
### Fenced Code Block<br>\
<br>\
```<br>\
{<br>\
  \"firstName\": \"John\",<br>\
  \"lastName\": \"Smith\",<br>\
  \"age\": 25<br>\
}<br>\
```<br>\
<br>\
### Strikethrough<br>\
<br>\
~~The world is flat.~~<br>\
<br>\
### Task List<br>\
<br>\
- [x] Write the press release<br>\
- [ ] Update the website<br>\
- [ ] Contact the media<br>\
"

	fAlert(lv);
}

function bQTag(){
	document.getElementById("input_title").value="^_^";
	eInpTitle();
}


function bSave(){
	clearResponse();
	
	//update openpage
	go_book.openpage=gv_sel_page;
	//prepare data to send:
	var oData={
		app:"bk",
		act:"save",
		data:go_book,
		session:{token:gv_sesstok}
	};

	//push JSON str to a value of "js":
	// var postData=encodeURIComponent(JSON.stringify(oData));
	//send data
	// xhrSend2(postData,function(oDataRt){
	// 	printResponse(oDataRt.msg);

	// 	if(oDataRt.book){
	// 		//update with new db rtn book:
	// 		go_book=oDataRt.book;
	// 		afterGetBook();
	// 		clearTimeout(gv_timer);//do not save draft after clicking SAVE
	// 		fSetSaveOff();
	// 	}
		
	// },function(){
	// 	printResponse("save server error");
	// });
	post("bSave",oData,function(oDataRt){
		printResponse(":"+oDataRt.msg);

		if(oDataRt.book){
			//update with new db rtn book:
			go_book=oDataRt.book;
			afterGetBook();
			clearTimeout(gv_timer);//do not save draft after clicking SAVE
			// fSetSaveOff();
		}
	});
}

function bMore(){
	toggleMoreButtons();
}

function bTest(){

	// var lv=go_book.sheets[findPageIndex(gv_sel_page)].sidea;
	// console.log(getPreviewLine(lv));

	// var lv_msg="Session timeout, SAVE button now disabled. ";
	// 	lv_msg=lv_msg+"You can still edit and it will automatically be saved as draft, then refresh the page to retrieve the SAVE button and retrieve the draft to save the content.";
	// 	document.getElementById("btnSave").disabled = true;
	// 	fAlert(lv_msg);

	// console.log("POSTing inittest:")
	// post_no_response(true,"inittest",{
	// 	app:'test',
	// 	act:'get',
	// 	session:{token:"aa"}
	// },function(oDataRt){
	// 	console.log("inittest")
	// 	console.log(oDataRt.msg)
	// });

	// console.log("POSTing inittest2:")
	// post_no_response(true,"inittest2",{
	// 	app:'test',
	// 	act:'get',
	// 	session:{token:"bb"}
	// },function(oDataRt){
	// 	console.log("inittest2")
	// 	console.log(oDataRt.msg)
	// });

	// saveDraft();


}

function bPrev(){
	clearResponse();
	
	if(gv_sel_page==1)
		printResponse("now in 1st page");
	else{
		gv_sel_page--;
		showPage(gv_sel_page);
	}
}

function bNext(){
	clearResponse();
	
	if(gv_sel_page==lastPage()+1)
		printResponse("now in last page");
	else{
		gv_sel_page++;
		showPage(gv_sel_page);
	}
}

function bMovePrev(){
	if(!gb_edit){
		fAlert("Not in edit mode!")
		return;
	}
	clearResponse();
	
	if(gv_sel_page==1){
		printResponse("Already 1st page.");
		return;
	}

	var lo_sheetSel=go_book.sheets[findPageIndex(gv_sel_page)];
	var lo_sheetPre=go_book.sheets[findPageIndex(gv_sel_page-1)];

	lo_sheetSel.page=lo_sheetSel.page-1;
	markPageChanged(lo_sheetSel);

	lo_sheetPre.page=lo_sheetPre.page+1;
	markPageChanged(lo_sheetPre);

	//update display
	gv_sel_page=gv_sel_page-1;
	showPage(gv_sel_page);
}

function bMoveNext(){
	if(!gb_edit){
		fAlert("Not in edit mode!")
		return;
	}
	clearResponse();

	if(gv_sel_page>=lastPage()){
		printResponse("Already last page.");
		return;
	}

	var lo_sheetSel=go_book.sheets[findPageIndex(gv_sel_page)];
	var lo_sheetNex=go_book.sheets[findPageIndex(gv_sel_page+1)];

	lo_sheetSel.page=lo_sheetSel.page+1;
	markPageChanged(lo_sheetSel);

	lo_sheetNex.page=lo_sheetNex.page-1;
	markPageChanged(lo_sheetNex);

	//update display
	gv_sel_page=gv_sel_page+1;
	showPage(gv_sel_page);
}

function bMoveBfr(){
	if(!gb_edit){
		fAlert("Not in edit mode!")
		return;
	}
	clearResponse();

	var lv_bfrP=Number(document.getElementById("input_movebfr").value);
	if(lv_bfrP){

		//validations:
		if(lv_bfrP==gv_sel_page || lv_bfrP==gv_sel_page+1){
			printResponse("Already in this position");
			return;
		}
		if(lv_bfrP>go_book.sheets.length){
			printResponse("Exceed total page, moving to end");
			lv_bfrP=go_book.sheets.length+1;
			document.getElementById("input_movebfr").value=lv_bfrP;
		}
		
		//set curr page temp page number
		go_book.sheets[findPageIndex(gv_sel_page)].page=-1;

		//shift page after the taken one by -1
		for(var i=0;i<go_book.sheets.length;i++){
			var lo_sheet=go_book.sheets[i];
			if(lo_sheet.page>gv_sel_page)
				shiftPage(lo_sheet,-1);
		}

		//if moving down, fix the lv_bfrP
		if(lv_bfrP>gv_sel_page) lv_bfrP--;

		//shift pages after new insert pos by 1
		for(var i=0;i<go_book.sheets.length;i++){
			var lo_sheet=go_book.sheets[i];
			if(lo_sheet.page>=lv_bfrP)
				shiftPage(lo_sheet,1);
		}

		//set temp page back
		go_book.sheets[findPageIndex(-1)].page=lv_bfrP;

		//update ui
		gv_sel_page=lv_bfrP;
		document.getElementById("input_movebfr").value=gv_sel_page;
		printPageNum();
		showPage(gv_sel_page);


	}
}
    /******************************/

    /* event */

// function eTimer0(){
// 	var lv=(Date.now()-gv_time_book_get)/1000;
// 	var lv_timeout=60*5; //5min
// 	// lv_timeout=5;//for dev only
// 	// printResponse(lv);
// 	if(lv>=lv_timeout && document.getElementById("btnSave").disabled == false){
// 		//lock SAVE button & alert:
// 		var lv_msg="Session timeout, SAVE button now disabled. ";
// 		lv_msg=lv_msg+"You can still edit and it will automatically be saved as draft, ";
// 		lv_msg=lv_msg+"then refresh the page to reactivate the SAVE button and retrieve the draft to save the content.";
// 		fAlert(lv_msg);
// 		document.getElementById("btnSave").disabled = true;
// 	}
// }
// old local timeout timer, not used now

function eClickInpA(){
	//if(!gb_edit) bNext();
}
function eClickInpB(){
	//if(!gb_edit) bPrev();
}

function eClickTitleA(){
	//if(gb_edit) bNext();
}
function eClickTitleB(){
	if(gb_edit) bPrev();
}

function eClickInpA(){
	//if(!gb_edit) bNext();
}
function eClickInpB(){
	if(!gb_edit) bPrev();
}
function eInpB(){
	clearResponse();
	
	if(gv_sel_page==1) return;//cover, don't do anything
	var lo=go_book.sheets[findPageIndex(gv_sel_page-1)]; //sel previous page
	lo.sideb=document.getElementById('tab').value;

	markPageChanged(lo);
	showPage(gv_sel_page); //reprint page to show change mark ("*")
}
function eInpA(){
	clearResponse();
	
	if(gv_sel_page==lastPage()+1) return;//end of book, don't do anything
	var lo=go_book.sheets[findPageIndex(gv_sel_page)];
	lo.sidea=document.getElementById('taa').value;//todo base64 encode

	markPageChanged(lo);
	showPage(gv_sel_page); //reprint page to show change mark ("*")
	fSetSaveOn();//illuminate save button

	clearTimeout(gv_timer);
	gv_timer=setTimeout("saveDraft()",2000);
}

function eInpTitle(){
	clearResponse();

	var lv_inp = document.getElementById("input_title").value;

	var lo=go_book.sheets[findPageIndex(gv_sel_page)];
	lo.title=lv_inp;
	markPageChanged(lo);

	//update display
	printPageNum();
	showPage(gv_sel_page);
}


/*---------------------------------------------*/
/* session functions */
function printSessStat(iv_class,iv){
	document.getElementById("sessionstat").innerHTML=iv;
	document.getElementById("sessionstat").setAttribute("class", iv_class);
}
// function sessionInit(){

// 	post_no_response(true,"sessionInit",{
// 		app:'session',
// 		act:'pbeg'
// 	},function(oDataRt){
// 		console.log(oDataRt);
// 		if(oDataRt.session.token) gv_sesstok=oDataRt.session.token;
// 		console.log("sessionInit:"+oDataRt.msg);
// 	});

// }
function sessionTimer(){

	post_no_response(POSTLOCK_SILENT,"sessionTimer",{
		app:'session',
		act:'achk',
		// sesstok:gv_sesstok
		session:{token:gv_sesstok}
	},function(oDataRt){
		// console.log(oDataRt);
		if(oDataRt.session.token) gv_sesstok=oDataRt.session.token;
		//msg if timeout
		if(oDataRt.session.remain==0 && !gb_timeoutwarned){
			var lv_msg="Session timeout, SAVE button now disabled. ";
			lv_msg=lv_msg+"You can still edit and it will automatically be saved as draft, then refresh the page to retrieve the SAVE button and retrieve the draft to save the content.";
			fAlert(lv_msg);

			document.getElementById("btnSave").disabled = true;	//disable SAVE button

			gb_timeoutwarned=true;
		}
		//chk timeout soon
		sesstionChkTimeoutStat(oDataRt.session.remain);

		// printResponse(":"+oDataRt.msg);
	},function(error){
		//possible network disconnects
		printSessStat(C_CLASS_LIGHT_E,"offline");
		printResponse(" server error");
		console.log("sessionTimer xhrSend3 error")
		console.log(error);
	
	});

}
function sesstionChkTimeoutStat(iv_remain){
	var lv_threshold=120000; 						//2 mins
	
	var lv_timerInterval=gv_timerInterval;

	if(iv_remain > lv_threshold)
		printSessStat(C_CLASS_LIGHT_S,"online");

	if(iv_remain<=lv_threshold && 
	   iv_remain > lv_timerInterval) 
		printSessStat(C_CLASS_LIGHT_W,""+parseInt(iv_remain/1000)+"s");

	if(iv_remain <= 0)
		printSessStat(C_CLASS_LIGHT_E,"timeout");
}
/*---------------------------------------------*/
function init(){
	printResponse("selecta book to start");

	hidePageB();
	updateTextarea("tab");
	updateTextarea("taa");
	updateMdElements();

	getInitBook();

	// bEd();//click Edit once to enable edit mode
	hideMoreButtons();//hide more button bar

	sessionTimer();
	//start timer0
	gv_timer0 = setInterval(function() {
		// eTimer0();
		sessionTimer();
  	}, gv_timerInterval);

}
init();
/*---------------------------------------------*/


    //监听全局键盘按下事件
    $(document).keydown(function (event) {
      //alert(event.keyCode);
      //16=Shift 17=Ctrl
      //91=Left Cmd(Mac) 93=Right Cmd(Mac)
	  /*
      if (event.keyCode == 16) fSetShiftOn();
      if (event.keyCode == 17) fSetCtrlOn();
      if (event.keyCode == 91) fSetCtrlOn();
      if (event.keyCode == 93) fSetCtrlOn();
	  */

    //   if (event.keyCode == 17) eClickInpB(); //ctrl
    //   if (event.keyCode == 91) eClickInpB(); //cmd

    //   if (event.keyCode == 16) eClickInpA(); //shift
    //   if (event.keyCode == 32) eClickInpA(); //space bar

      if (event.keyCode == 37) eClickInpB(); //left arr
      if (event.keyCode == 38) eClickInpB(); //up arr

      if (event.keyCode == 39) eClickInpA(); //right arr
      if (event.keyCode == 40) eClickInpA(); //down arr

    });

    $(document).keyup(function (event) {
		/*
      if (event.keyCode == 16) fSetShiftOff();
      if (event.keyCode == 17) fSetCtrlOff();
      if (event.keyCode == 91) fSetCtrlOff();
      if (event.keyCode == 93) fSetCtrlOff();
	  */
    });

    /* on page load */

  </script>

</html>